# Heatwave-ABM: Agent-Based Heatwave Simulation with LLM Hooks


# Process Step

pip install --upgrade google-genai


export  GEMINI_API_KEY=xxx
ref to:  https://chatgpt.com/c/69223684-0188-8328-8fd0-f186d105ad86

#  --no-llm   --silent     # turn on if needed  
python main.py   --agents-path    data/agents.csv   --weather-path data/weather.csv    --no-llm       

python visualize_results.py

# Introduction



This project simulates how **individual people (agents)** experience and respond to **heatwaves**, and how:

- Their **decisions**  
  (`drink water`, `go to hospital`, `turn on AC`, `change outdoor exposure`)
- Their **social context**  
  (family, workplace/company)
- Their **environment**  
  (temperature, humidity, AC availability)

combine to affect **physical health** and **mental health** over time.

You can run the system in two modes:

1. **Pure rule-based** (fast, no LLM calls, just Python).
2. **LLM-augmented** (using Gemini / GPT / Qwen via `llm_interfaces.py`), where:
   - Weather warnings are generated by LLM.
   - Families and companies coordinate via LLM “group chats”.
   - Individual risk is assessed by an LLM that understands age + disease groups.
   - Heat-related diseases are generated by LLM based on exposure & vulnerability.

All decisions and states are logged per agent per day, so you can analyze behavior or learn policies later.

---

## 0. Installation & Basic Setup

### Dependencies

This project uses:

- Python 3.10+ (recommended)
- `google-genai` (for Gemini, if you use LLMs)
- `openai` (if you want GPT or Qwen instead of Gemini)
- `pandas` (for visualization)
- `matplotlib` (for visualization plots)

Install everything with:

```bash
pip install --upgrade google-genai openai pandas matplotlib
````

(or add them to `requirements.txt` and do `pip install -r requirements.txt`).

### LLM API Keys (optional)

If you want to use **Gemini 3.0** (default in this code):

```bash
pip install --upgrade google-genai
export GEMINI_API_KEY=YOUR_KEY_HERE
```

In `llm_interfaces.py`:

```python
PROVIDER = "gemini"
GEMINI_MODEL = "gemini-3-pro-preview"
```

If you prefer **OpenAI GPT**:

```bash
pip install openai
export OPENAI_API_KEY=YOUR_KEY_HERE
```

Then set:

```python
PROVIDER = "openai"
OPENAI_MODEL = "gpt-4.1-mini"  # or another supported model
```

If you prefer **Qwen (DashScope)**:

```bash
pip install openai
export DASHSCOPE_API_KEY=YOUR_DASHSCOPE_KEY
```

Then set:

```python
PROVIDER = "qwen"
QWEN_MODEL = "qwen-max"
QWEN_BASE_URL = "https://dashscope-intl.aliyuncs.com/compatible-mode/v1"
```

If you don’t want any LLMs at all, you can either:

* Pass `--no-llm` at runtime (recommended), **or**
* Set `PROVIDER = "none"` in `llm_interfaces.py`.

---

## 1. How to Run

### Basic simulation (rule-based only)

```bash
python main.py \
  --agents-path data/agents.csv \
  --weather-path data/weather.csv \
  --no-llm
```

Flags:

* `--agents-path`
  Path to the agent configuration CSV (default: `data/agents.csv`).
* `--weather-path`
  Path to the weather CSV (default: `data/weather.csv`).
  If not found, synthetic dummy weather is generated.
* `--no-llm`
  **Disables all LLM usage** (weather, family/company plans, personal risk, diseases),
  everything is rule-based.
* `--silent`
  Reduces console output.

### Simulation with LLM features

Once your API key is set and `PROVIDER` is configured:

```bash
export GEMINI_API_KEY=YOUR_KEY_HERE

python main.py \
  --agents-path data/agents.csv \
  --weather-path data/weather.csv
```

No `--no-llm` → all LLM hooks are active.

### Visualization

After running `main.py`, the simulation writes CSV outputs to `output/`.
To generate plots:

```bash
python visualize_results.py
```

This produces:

* `output/plot_avg_health_mental.png`
* `output/plot_final_health_by_age_group.png`
* `output/plot_heat_conditions_by_age_group.png`
* `output/plot_sample_agent_trajectories.png`

---

## 2. Project Structure

```text
heatwave_abm/
├─ README.md                 # This file
├─ main.py                   # Entry point to run a simulation
├─ config.py                 # Global parameters for risk & state dynamics
├─ agents.py                 # Agent class: profile, decision, state updates
├─ environment.py            # Weather loading/generation & EnvironmentState
├─ groups.py                 # Family & Company group coordination (rule + LLM)
├─ llm_interfaces.py         # LLM provider config, prompts, parsers
├─ data_loader.py            # Loads agents, families, companies from CSV
├─ simulation.py             # Main simulation loop & logging
├─ output_utils.py           # Save logs to CSV
├─ visualize_results.py      # Generate plots from CSV logs
└─ data/
   ├─ agents.csv             # Initial agent profiles & group membership
   └─ weather.csv            # Daily weather: date, temperature, humidity
```

---

## 3. Data Formats

### 3.1 `data/agents.csv`

Example header:

```csv
agent_id,age,sex,job,baseline_health,baseline_mental,outdoor_hours,risk_sensitivity,family_id,company_id,has_chronic_disease,disease_name
1,32,M,office,0.9,0.8,1.5,0.6,1,10,0,
2,68,F,retired,0.7,0.7,0.5,0.8,1,,1,heart disease
3,45,M,construction,0.8,0.6,6.0,0.7,,10,0,
```

Required columns:

* `agent_id`: integer unique ID.
* `age`: integer.
* `sex`: free text (`M`, `F`, or any string).
* `job`: free text (`office`, `construction`, `delivery`, `farmer`, etc.).
* `baseline_health`: float [0, 1].
* `baseline_mental`: float [0, 1].
* `outdoor_hours`: typical daily outdoor exposure (float hours).
* `risk_sensitivity`: float [0, 1], how strongly they react to perceived risk.

Group membership:

* `family_id`: optional; all agents with same ID belong to same family.
* `company_id`: optional; all agents with same ID belong to same company.

Health risk fields:

* `has_chronic_disease`: `0/1`, `true/false`, or `yes/no`.
* `disease_name`: free text (`diabetes`, `heart disease`, `asthma`, etc.).
  Mapped into disease groups like `cardio`, `diabetes`, `respiratory`, `renal`, `other`.

### 3.2 `data/weather.csv`

Example:

```csv
date,temperature,humidity
2025-07-01,29,0.45
2025-07-02,33,0.60
2025-07-03,40,0.75
```

* `date`: free text, not used in computation but useful for tracking.
* `temperature`: °C.
* `humidity`: either 0–1 or 0–100; values > 1 are automatically scaled down.

If `data/weather.csv` is missing, `generate_dummy_weather()` in `environment.py` creates a synthetic heatwave pattern.

---

## 4. Model Design

### 4.1 Agents

Defined in `agents.py` as `Agent` dataclass.

Each agent has:

* **Profile**

  * `id`
  * `age`, mapped into 7 age groups:

    * `infant_0_4`
    * `child_5_12`
    * `teen_13_17`
    * `young_adult_18_39`
    * `middle_aged_40_59`
    * `older_adult_60_74`
    * `senior_75_plus`
  * `sex`
  * `job` (affects minimum outdoor hours for some jobs)
* **Baseline state**

  * `baseline_health` ∈ [0, 1]
  * `baseline_mental` ∈ [0, 1]
* **Behavior traits**

  * `outdoor_hours`: normal daily exposure
  * `risk_sensitivity`: 0–1, multiplies perceived risk
* **Health-related**

  * `has_chronic_disease` (bool)
  * `disease_name` → mapped into:

    * `none`, `cardio`, `diabetes`, `respiratory`, `renal`, `other`
* **Dynamic state**

  * `health` ∈ [0, 1]
  * `mental` ∈ [0, 1]
  * `hydration` ∈ [0, 1]
  * `heat_condition`: e.g. `none`, `heat_exhaustion`, `heatstroke`, `dehydration`, etc.
  * `heat_condition_severity` ∈ [0, 1]

#### Daily decisions

Each day, the agent must output:

* `drink_water` (bool)
* `go_hospital` (bool)
* `use_ac` (bool)
* `target_outdoor_hours` (float, 0–24)

Two modes:

* **Rule-based** (`mode="rule"`):
  Uses a risk formula combining temperature, humidity, age, current health, and `risk_sensitivity`.
* **LLM-based** (`mode="llm"`):
  Uses an LLM (via `build_llm_prompt_for_agent`) to choose actions (only if `use_llm=True`).

### 4.2 Environment

Defined in `environment.py` as `EnvironmentState`:

* `day`: integer index.
* `temperature`: °C.
* `humidity`: 0–1.
* `ac_available`: bool for that day (sampled using `ac_available_fraction` in `Simulation`).

### 4.3 Groups (Families & Companies)

Defined in `groups.py`:

* `Family(id, member_ids)`
* `Company(id, member_ids)`

Each has:

* `plan_rule_based(...)`: deterministic group policy.
* `plan_with_llm(...)`:
  calls LLM using family/company prompts if LLM is enabled, otherwise falls back to rule-based.

Group plans can override/adjust individual actions.
Each agent may or may not follow the group with probability `group_influence_prob`.

### 4.4 LLM Integration

All LLM logic is in `llm_interfaces.py`.

Key concepts:

* **Global switch**:

  * `GLOBAL_LLM_ENABLED` and `set_global_llm_enabled()`
    controlled by CLI flag `--no-llm`.
  * If disabled, **no** LLM calls are made; all logic is rule-based.
* **Provider selection** via `PROVIDER`:

  * `"gemini"`, `"openai"`, `"qwen"`, or `"none"`.

LLM endpoints used:

* `call_llm_api(prompt, tag)` → raw text.
* `build_personal_risk_prompt(agent, env)` → JSON:

  * risk explanation (temperature, humidity, age_group, disease_group),
  * `overall_risk_level` (`low`/`medium`/`high`/`critical`),
  * `overall_risk_multiplier`,
  * `sickness_base_probability`,
  * recommended `actions`.
* `build_heat_disease_prompt(...)` → JSON:

  * `sickness_probability`,
  * `condition` (e.g. `heat_exhaustion`, `heatstroke`, `dehydration`, `kidney_strain`, `heat_rash`),
  * `severity`,
  * `needs_hospital`,
  * `description`.
* `build_family_conversation_prompt(...)` / `build_company_conversation_prompt(...)`:

  * LLM returns joint plan for all members.
* `build_weather_broadcast_prompt`:

  * LLM returns `risk_level` and human-readable `message`.

If `--no-llm` is active, none of these are called.
The simulation uses heuristic/rule-based logic everywhere.

---

## 5. Health & Mental Dynamics

The function `Agent.update_state(...)` (in `agents.py`) implements the physical & mental dynamics.

### 5.1 Comfortable vs Hot Days

We distinguish:

* **Comfortable day**:

  * `temperature <= comfort_temp_max` (e.g. 30°C)
  * `humidity <= comfort_humidity_max` (e.g. 0.7)
  * Result:

    * **No heat damage**
    * Health and mental **recover** toward their baselines:

      * base recovery: `health_recovery_rate`, `mental_recovery_rate`
      * extra comfort bonus: `comfort_health_recovery_bonus`, `comfort_mental_recovery_bonus`
* **Hot / stressful day**:

  * Above the comfort band; heat damage computed from:

    * temperature vs `heat_temp` / `extreme_temp`
    * humidity
    * outdoor exposure
    * hydration
    * AC & hospital mitigation

### 5.2 Heat Stress

On hot days:

* Temperature-based stress:

  * Small stress between `comfort_temp_max` and `heat_temp`.
  * Stronger stress above `heat_temp`, especially above `extreme_temp`.
* Humidity factor:

  * Only humidity above 0.5 amplifies stress; controlled by `humidity_heat_amplifier`.
* Exposure factor:

  * `outdoor_hours` relative to typical `outdoor_hours`.
* Hydration factor:

  * Dehydration multiplies stress (factor between 1 and 2).
* AC:

  * Multiplies heat stress by `ac_heat_reduction_factor` (e.g. 0.3 → big protection).
* Hospital:

  * Multiplies stress by `hospital_relief_factor` (e.g. 0.3) and adds health/mental boost.

### 5.3 Health Update

* Base damage:
  `health_damage = health_sensitivity * heat_stress * age_factor`
* `age_factor` increases damage for older agents.
* Damage is capped daily by `max_daily_health_damage`.
* Hospital adds `hospital_health_boost` (small partial recovery).
* On all days (comfortable or hot), if health < baseline:

  * `health += health_recovery_rate * (baseline_health - health)`
* On comfortable days, an extra bonus recovery is added.
* Final `health` is always clamped to [0, 1].

### 5.4 Mental Update

Mental state is **not** perfectly tied to physical health.

Mental damage components:

* Heat stress: `mental_heat_sensitivity * heat_stress`
* Social isolation: `mental_isolation_weight * isolation_factor`

  * isolation if they stay inside much more than usual.
* Low health: if `health < 0.5`, extra mental drag.

Daily mental damage is capped by `max_daily_mental_damage`.

Recovery:

* Hospital adds `hospital_mental_boost`.
* If mental < `mental_help_threshold`, they “seek mental help” (e.g. professionals/government):

  * one-time boost: `mental_help_boost`.
* Then gradual recovery toward `baseline_mental`:

  * `mental += mental_recovery_rate * (baseline_mental - mental)`
* On comfortable days, extra `comfort_mental_recovery_bonus` is applied.

Mental is also clamped to [0, 1].

---

## 6. Simulation Flow

Implemented in `simulation.py`:

1. **Initialization**

   * Load agents + families + companies from `data/agents.csv`.
   * Load weather series from `data/weather.csv` or generate dummy.
   * Initialize parameters via `default_params()` in `config.py`.

2. **Daily loop (for each day)**

   * Build `EnvironmentState` (temp, humidity, AC availability).
   * Optional LLM **weather announcement** (if `use_llm=True`).
   * For each family:

     * Get a plan via `plan_with_llm` or `plan_rule_based`.
   * For each company:

     * Same as above.
   * For each agent:

     * If `use_llm=True`, call personal risk LLM (`build_personal_risk_prompt`) to:

       * get risk level & multiplier,
       * get recommended actions,
       * get base sickness probability.
     * Otherwise, use rule-based `Agent.decide(...)`.
     * Combine personal action with group plan (family/company), with probability `group_influence_prob`.
     * Update state using `Agent.update_state(...)`.
     * If health or mental are low, and LLM is enabled:

       * call heat disease LLM (`build_heat_disease_prompt`),
       * sample if a new heat condition occurs,
       * apply extra damage & set `heat_condition`.

3. **Logging**

   * For every `(day, agent)`:

     * Environment info
     * Base and final decisions (drink_water, go_hospital, use_ac, outdoor hours)
     * Health/mental/hydration before and after
     * Personal LLM risk factors, if available
     * Heat-disease candidate & chosen condition, if any
     * Whether group plan was used

4. **Summary**

   * For each day: average health and mental across all agents.

The `SimulationResult` returned from `sim.run()` contains:

* `history`: list of `{day, avg_health, avg_mental}`.
* `agents`: final list of `Agent` objects.
* `agent_daily_log`: full per-agent, per-day rows.

---

## 7. Outputs

### 7.1 CSV Logs

Using `output_utils.py`, after each run:

* `output/agent_daily_log.csv`:

  * One row per `(day, agent_id)`.
  * Contains:

    * demographics and disease group,
    * weather and AC availability,
    * personal risk metrics (if LLM),
    * raw and final actions,
    * health/mental/hydration before/after,
    * candidate heat diseases and chosen condition (if any),
    * whether group plans were used.
* `output/daily_summary.csv`:

  * One row per day:

    * `day`, `avg_health`, `avg_mental`.

You can load these with pandas, R, Excel, etc., for further analysis.

### 7.2 Visualization

`visualize_results.py` builds several plots from these CSVs:

* Daily average health & mental.
* Final-day health distribution per age group.
* Heat-related conditions per age group.
* Trajectories of health/mental for a handful of sample agents.

---

## 8. Tuning & Extensions

You can tweak the model behavior via `config.py`:

* **When does heat start to hurt?**

  * `comfort_temp_max`, `comfort_humidity_max`
  * `heat_temp`, `extreme_temp`
* **How strong is damage vs recovery?**

  * `health_sensitivity`, `mental_heat_sensitivity`
  * `max_daily_health_damage`, `max_daily_mental_damage`
  * `health_recovery_rate`, `mental_recovery_rate`
  * `comfort_health_recovery_bonus`, `comfort_mental_recovery_bonus`
* **Effectiveness of interventions**

  * `drink_hydration_boost`
  * `ac_heat_reduction_factor`
  * `hospital_relief_factor`
  * `hospital_health_boost`, `hospital_mental_boost`
  * `mental_help_threshold`, `mental_help_boost`

Possible extensions:

* Add **economic state** to agents (AC costs money, hospital visits cost money).
* Add **policy interventions** (government cooling centers, subsidies).
* Learn **policy parameters** (e.g., weights of risk perception) via optimization against a target outcome (e.g. desired final death rate).


